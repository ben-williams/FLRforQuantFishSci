
Statistical catch at age models with FLa4a
=========================

Ispra, 18th - 22nd March, 2013
-------------------------

# Install FLa4a

```{r eval=FALSE}
install.packages("RcppArmadillo")
install.packages("FLa4a", repos="http://flr-project.org/Rdevel")
```

---
# load the libary and some data


We are going to demonstrate a **statistical catch at age** using the assessment for all (**a4a**) assessment model.

The model and some test data can be found in the `FLa4a` package

```{r message=FALSE}
library(FLa4a)
data(hakeGSA7)
data(hakeGSA7.idx)
```


here is a fairly complicated plot of the data in the hake stock object.  Please don't worry about understanding the code.  If you want to understand what it is doing you can always ask - otherwise you can reuse it or forget it or whatever.


```{r fig.width = 14, fig.height = 7}
# choose what slots to display
slots <- c("catch.n", "catch.wt", "mat", "m")

# choose what you want them labelled as
snames <- c("Catch Numbers", "Catch Weight", "Maturity", "Natural Mortality")

# create the plot  - dont worry about the details
xyplot(data ~ year | factor(slot, levels = slots, labels = snames), group = age, 
       data = hakeGSA7, subset = slot %in% slots, drop.unused.levels = TRUE,
       panel = function(x, y, ...) {
         panel.xyplot(x, y, type = c("g", "p", "l"), ...)
         if (current.column() == 2) 
           panel.xyplot(x, y, type = "smooth", lty = 2, col = grey(0.4), ...)
       }, scales = list(relation = "free"),
       layout = c(4,1), auto.key = list(columns = 4, lines = 1, title = "Ages"))
```

# But we are not here for that!

---


# Lets fit a very simple model :)

Always follow these steps:
- choose a model for log Fishing mortality
- choose a model for log survey catchability
- fit the model
- inspect the fit


```{r}
# choose a model for log Fishing mortality
fmodel <- ~ 1

# choose a model for survey catchablity
qmodel <- list( ~ 1 )

# fit the model
simplefit <- a4aFit(fmodel, qmodel, stock = hakeGSA7,  indices = hakeGSA7.idx)
simplefit
```
lets look at the estimates of recruitment, Fbar, and SSB are

```{r message=FALSE}
# add the predictions to the origional stock object to fill in stock.n and harvest
simpleHake <- hakeGSA7 + simplefit
# plot the fitted stock object
plot(simpleHake)
```
and the residuals

```{r message=FALSE}
# residuals about what the model predicts the catch should be
xyplot(data ~ year | paste("age", age), data = catch.lres(simplefit), type = c("g","p","smooth"), 
     lty = 2, col = 1, ylab = "standardised residual", as.table = TRUE, main = "log (Catch) Residuals")

# residuals about what the model predicts the survey indices should be
xyplot(data ~ year | paste("age", age), data = index.lres(simplefit)[[1]], type = c("g","p","smooth"), 
     lty = 2, col = 1, ylab = "standardised residual", as.table = TRUE, main = "log (Index) Residuals")
```


# Okay - so can we do better? 
Lets try including age as a factor
----------------------------------

```{r}
# choose a model for log Fishing mortality
fmodel <- ~ factor(age)

# choose a model for survey catchablity
qmodel <- list( ~ 1 )

# fit the model
fit2 <- a4aFit(fmodel, qmodel, stock = hakeGSA7,  indices = hakeGSA7.idx)
AIC(simplefit, fit2)
```

Lets try adding year as a factor
----------------------------------
```{r}
# fit the model
fit3 <- a4aFit(~ factor(age) + factor(year), list( ~ 1 ), stock = hakeGSA7,  indices = hakeGSA7.idx)
AIC(simplefit, fit2, fit3)
xyplot(data ~ age, data = harvest(fit3), groups = year, type = "l", auto.key = list(columns = 4))
```

Whats going on!
----------------------------------
Lets look at the catch at age matrix
```{r}
# lets look at the catches
catch.n(hakeGSA7)
```
There is nothing strange here - The catches are small at ages 5 and 6 but that is fine.  It is likey that the model is too flexible with respect to age - this is why in other models such as XSA you have to set a rule for calculating the F at the older ages.

**But we can do better !!**

Lets try modelling F at age using a smoother
----------------------------------

```{r, warning=FALSE}
# fit the model
fit4 <- a4aFit(~ s(age, k = 4) + factor(year), list( ~ 1 ), stock = hakeGSA7,  indices = hakeGSA7.idx)
```

```{r, warning=FALSE}
AIC(simplefit, fit2, fit3, fit4)
xyplot(data ~ age, data = harvest(fit4), groups = year, type = "l", auto.key = list(columns = 4))
fit5 <- a4aFit(~ s(age, k = 4) + factor(year), list( ~ age ), stock = hakeGSA7,  indices = hakeGSA7.idx)
fit6 <- a4aFit(~ s(age, k = 4) + factor(year), list( ~ s(age, k=4) ), stock = hakeGSA7,  indices = hakeGSA7.idx)
fit7 <- a4aFit(~ s(age, k = 4) + s(year, k = 6), list( ~ s(age, k=4) ), stock = hakeGSA7,  indices = hakeGSA7.idx)
AIC(simplefit, fit2, fit3, fit4, fit5, fit6, fit7)
bestfit <- fit7
```
So you might think that if we keep adding stuff the fit will just get better and better...

```{r, warning=FALSE}
fit8 <- a4aFit(~ s(age, k = 5) + s(year, k = 6), list( ~ s(age, k=4) ), stock = hakeGSA7,  indices = hakeGSA7.idx)
fit9 <- a4aFit(~ s(age, k = 4) + s(year, k = 7), list( ~ s(age, k=4) ), stock = hakeGSA7,  indices = hakeGSA7.idx)
fit10 <- a4aFit(~ s(age, k = 4) + s(year, k = 6), list( ~ s(age, k=5) ), stock = hakeGSA7,  indices = hakeGSA7.idx)
AIC(bestfit, fit8, fit9, fit10)
```
So the best fit is
```{r, warning=FALSE}
bestfit
xyplot(data ~ age, data = harvest(fit4), groups = year, type = "l", auto.key = list(columns = 4))
plot(hakeGSA7 + bestfit)
```

Lets have a look at the residuals
----------------------------------
```{r message=FALSE}
# residuals about what the model predicts the catch should be
xyplot(data ~ year | paste("age", age), data = catch.lres(bestfit), type = c("g","p","smooth"), 
     lty = 2, col = 1, ylab = "standardised residual", as.table = TRUE, main = "log (Catch) Residuals")

# residuals about what the model predicts the survey indices should be
xyplot(data ~ year | paste("age", age), data = index.lres(bestfit)[[1]], type = c("g","p","smooth"), 
     lty = 2, col = 1, ylab = "standardised residual", as.table = TRUE, main = "log (Index) Residuals")
```

Here are some functions to make nicer plots
----------------------------------
```{r message=FALSE}
# residuals
plot(bestfit, hakeGSA7, what = "Res")

# Fishing mortality
plot(bestfit, hakeGSA7, what = "F")

# survey catchability
plot(bestfit, hakeGSA7, what = "Q")

# Stock Numbers
plot(bestfit, hakeGSA7, what = "N")

# all at once!!
plot(bestfit, hakeGSA7)
```

---







